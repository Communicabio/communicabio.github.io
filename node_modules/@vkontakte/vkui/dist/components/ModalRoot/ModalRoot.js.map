{"version":3,"sources":["../../../src/components/ModalRoot/ModalRoot.tsx"],"names":["TYPE_CARD","TYPE_PAGE","numberInRange","number","range","rangeTranslate","Math","max","min","ModalRoot","props","event","originalEvent","preventDefault","state","activeModal","nextModal","modalId","modalState","modalsState","undefined","type","dynamicContentHeight","switching","waitTransitionFinish","requestAnimationFrame","checkPageContentHeight","e","onPageTouchMove","onCardTouchMove","onPageTouchEnd","onCardTouchEnd","target","closest","contentScrolled","clearTimeout","contentScrollStopTimeout","window","setTimeout","activeTransitions","newState","prevModal","visibleModals","animated","history","setState","onClose","id","console","error","triggerActiveModalClose","isBack","inited","touchDown","dragging","maskElementRef","React","createRef","initModalsState","modalRootContext","updateModalHeight","frameIds","modals","reduce","acc","Modal","modalProps","settlingHeight","initActiveModal","toggleDocumentScrolling","prevProps","prevState","warn","includes","splice","indexOf","push","closeActiveModal","switchPrevNext","document","activeElement","HTMLElement","blur","enabled","documentScrolling","removeEventListener","preventTouch","passive","addEventListener","getElementById","modalElement","pickModal","querySelector","initPageModal","initCardModal","contentElement","contentHeight","firstElementChild","offsetHeight","prevTranslateY","translateY","expandable","clientHeight","innerElement","headerElement","footerElement","collapsed","expanded","translateYFrom","expandedRange","collapsedRange","hiddenRange","shiftHalf","visiblePart","headerHeight","height","parentElement","prevModalState","currentModalState","needAnimate","animateTranslate","animatePageHeader","prevNextSwitchEndHandler","setMaskOpacity","shiftY","startT","isY","stopPropagation","touchStartTime","touchStartContentScrollTop","scrollTop","touchMovePositive","shiftYPercent","innerHeight","shiftYCurrent","platform","ANDROID","touchShiftYPercent","translateYCurrent","startY","next","shiftYEndPercent","expectTranslateY","Date","now","getTime","hidden","doCloseModal","eventHandler","eventName","transitionEvents","transitionEndEventName","onceHandler","nextModalState","prevIsPage","prevIsCard","nextIsPage","nextIsCard","currentPercent","frameId","cancelAnimationFrame","footerHeight","factor","headerOpenPercent","headerShadow","style","opacity","toString","forceOpacity","maskAnimationFrame","current","activeModalState","webviewType","onTouchMove","onTouchEnd","onScroll","onMaskClick","map","isPage","key","context","WebviewType","VKAPPS","concat","children","Component","PropTypes","any","oneOf","INTERNAL"],"mappings":"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","sourcesContent":["import React, { Component, ReactElement, SyntheticEvent } from 'react';\nimport PropTypes from 'prop-types';\nimport Touch, { TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport getClassName from '../../helpers/getClassName';\nimport classNames from '../../lib/classNames';\nimport { setTransformStyle } from '../../lib/styles';\nimport { rubber } from '../../lib/touch';\nimport { isFunction } from '../../lib/utils';\nimport { ANDROID } from '../../lib/platform';\nimport transitionEvents from '../../lib/transitionEvents';\nimport { HasChildren, HasPlatform } from '../../types';\nimport withPlatform from '../../hoc/withPlatform';\nimport ModalRootContext, { ModalRootContextInterface } from './ModalRootContext';\nimport { WebviewType } from '../ConfigProvider/ConfigProviderContext';\n\nexport const TYPE_CARD = 'modal-card';\nexport const TYPE_PAGE = 'modal-page';\n\nfunction numberInRange(number: number, range: number[]) {\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number: number) {\n  return Math.max(0, Math.min(98, number));\n}\n\nexport interface ModalsStateEntry {\n  id: string;\n  onClose?: () => {};\n  type?: 'modal-card' | 'modal-page';\n\n  settlingHeight?: number;\n  dynamicContentHeight?: boolean;\n  expandable?: boolean;\n\n  modalElement?: HTMLElement;\n  innerElement?: HTMLElement;\n  headerElement?: HTMLElement;\n  contentElement?: HTMLElement;\n  footerElement?: HTMLElement;\n\n  translateY?: number;\n  translateYFrom?: number;\n  translateYCurrent?: number;\n  touchStartTime?: Date;\n  touchStartContentScrollTop?: number;\n  touchMovePositive?: boolean | null;\n  touchShiftYPercent?: number;\n  expanded?: boolean;\n  collapsed?: boolean;\n  hidden?: boolean;\n  contentScrolled?: boolean;\n  expandedRange?: [number, number];\n  collapsedRange?: [number, number];\n  hiddenRange?: [number, number];\n  contentScrollStopTimeout?: number;\n}\n\nexport interface ModalRootProps extends HasChildren, HasPlatform {\n  activeModal?: string | null;\n\n  /**\n   * Будет вызвано при закрытии активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n}\n\nexport interface ModalRootState {\n  activeModal?: string;\n  prevModal?: string;\n  nextModal?: string;\n  visibleModals?: string[];\n  animated?: boolean;\n  switching?: boolean;\n  history?: string[];\n  isBack?: boolean;\n  inited?: boolean;\n  touchDown?: boolean;\n  dragging?: boolean;\n}\n\nclass ModalRoot extends Component<ModalRootProps, ModalRootState> {\n  constructor(props: ModalRootProps) {\n    super(props);\n\n    const activeModal = props.activeModal;\n\n    this.state = {\n      activeModal: null,\n      prevModal: null,\n      nextModal: activeModal,\n      visibleModals: activeModal ? [activeModal] : [],\n      animated: !!activeModal,\n      switching: false,\n      history: activeModal ? [activeModal] : [],\n      isBack: false,\n      inited: false,\n      touchDown: false,\n      dragging: false,\n    };\n\n    this.activeTransitions = 0;\n    this.maskElementRef = React.createRef();\n\n    this.initModalsState();\n\n    this.modalRootContext = {\n      updateModalHeight: this.updateModalHeight,\n    };\n\n    this.frameIds = {};\n  }\n\n  private modalsState: { [id: string]: ModalsStateEntry };\n  private documentScrolling: boolean;\n  private activeTransitions: number;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private readonly frameIds: {\n    [index: string]: number;\n  };\n\n  static contextTypes = {\n    window: PropTypes.any,\n    document: PropTypes.any,\n    webviewType: PropTypes.oneOf([WebviewType.VKAPPS, WebviewType.INTERNAL]),\n  };\n\n  get document(): Document {\n    return this.context.document || document;\n  }\n\n  get window(): Window {\n    return this.context.window || window;\n  }\n\n  get webviewType(): WebviewType {\n    return this.context.webviewType || WebviewType.VKAPPS;\n  }\n\n  get modals() {\n    return [].concat(this.props.children);\n  }\n\n  initModalsState() {\n    this.modalsState = this.modals.reduce((acc, Modal) => {\n      const modalProps = Modal.props;\n      const state: ModalsStateEntry = {\n        id: Modal.props.id,\n        onClose: Modal.props.onClose,\n        dynamicContentHeight: !!modalProps.dynamicContentHeight,\n      };\n\n      // ModalPage props\n      if (typeof modalProps.settlingHeight === 'number') {\n        state.settlingHeight = modalProps.settlingHeight;\n      }\n\n      acc[state.id] = state;\n      return acc;\n    }, {});\n  }\n\n  componentDidMount() {\n    this.initActiveModal();\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps, prevState: ModalRootState) {\n    if (this.props.activeModal !== prevProps.activeModal && !this.state.switching) {\n      const nextModal = this.props.activeModal;\n      const prevModal = prevProps.activeModal;\n\n      if (nextModal !== null && !this.modalsState[nextModal]) {\n        return console.warn(`[ModalRoot.componentDidUpdate] nextModal ${nextModal} not found`);\n      }\n\n      let history = [...this.state.history];\n      let isBack = false;\n\n      if (nextModal === null) {\n        history = [];\n      } else if (history.includes(nextModal)) {\n        history = history.splice(0, history.indexOf(nextModal) + 1);\n        isBack = true;\n      } else {\n        history.push(nextModal);\n      }\n\n      return this.setState({\n        activeModal: null,\n        nextModal,\n        prevModal,\n        visibleModals: [nextModal, prevModal],\n        history,\n        isBack,\n        animated: true,\n        inited: false,\n        switching: false,\n      }, () => {\n        if (nextModal === null) {\n          this.closeActiveModal();\n        } else {\n          this.initActiveModal();\n        }\n      });\n    }\n\n    if (this.state.switching && !prevState.switching) {\n      requestAnimationFrame(() => this.switchPrevNext());\n    }\n\n    if (!this.state.activeModal && !this.state.prevModal && !this.state.nextModal) {\n      this.toggleDocumentScrolling(true);\n    } else {\n      this.toggleDocumentScrolling(false);\n    }\n  }\n\n  blurActiveElement() {\n    if (typeof this.window !== 'undefined' && this.document.activeElement instanceof HTMLElement) {\n      this.document.activeElement.blur();\n    }\n  }\n\n  /* Отключает скролл документа */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // Здесь нужен последний аргумент с такими же параметрами, потому что\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      // @ts-ignore (В интерфейсе EventListenerOptions нет поля passive)\n      this.window.removeEventListener('touchmove', this.preventTouch, { passive: false });\n    } else {\n      this.window.addEventListener('touchmove', this.preventTouch, { passive: false });\n    }\n  }\n\n  preventTouch = (event: any) => {\n    if (!event) {\n      return false;\n    }\n    while (event.originalEvent) {\n      event = event.originalEvent;\n    }\n    if (event.preventDefault) {\n      event.preventDefault();\n    }\n    return false;\n  };\n\n  pickModal(modalId: string) {\n    return this.document.getElementById('modal-' + modalId);\n  }\n\n  /**\n   * Инициализирует модалку перед анимацией открытия\n   */\n  initActiveModal() {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalElement = this.pickModal(activeModal);\n    const modalState = this.modalsState[activeModal];\n\n    if (modalElement.querySelector('.ModalPage')) {\n      modalState.type = TYPE_PAGE;\n    } else if (modalElement.querySelector('.ModalCard')) {\n      modalState.type = TYPE_CARD;\n    }\n\n    switch (modalState.type) {\n      case TYPE_PAGE:\n        modalState.settlingHeight = modalState.settlingHeight || 75;\n        this.initPageModal(modalState, modalElement);\n        break;\n\n      case TYPE_CARD:\n        this.initCardModal(modalState, modalElement);\n        break;\n\n      default:\n        console.warn('[ModalRoot.initActiveModal] modalState.type is unknown');\n    }\n\n    this.setState({ inited: true, switching: true });\n  }\n\n  initPageModal(modalState: ModalsStateEntry, modalElement: HTMLElement) {\n    const contentElement: HTMLElement = modalElement.querySelector('.ModalPage__content');\n    const contentHeight = (contentElement.firstElementChild as HTMLElement).offsetHeight;\n\n    let prevTranslateY = modalState.translateY;\n\n    modalState.expandable = contentHeight > contentElement.clientHeight;\n\n    modalState.modalElement = modalElement;\n    modalState.innerElement = modalElement.querySelector('.ModalPage__in-wrap');\n    modalState.headerElement = modalElement.querySelector('.ModalPage__header');\n    modalState.contentElement = modalElement.querySelector('.ModalPage__content');\n    modalState.footerElement = modalElement.querySelector('.ModalPage__footer');\n\n    let collapsed = false;\n    let expanded = false;\n    let translateYFrom;\n    let translateY;\n    let expandedRange: [number, number];\n    let collapsedRange: [number, number];\n    let hiddenRange: [number, number];\n\n    if (modalState.expandable) {\n      translateYFrom = 100 - modalState.settlingHeight;\n\n      const shiftHalf = translateYFrom / 2;\n      const visiblePart = 100 - translateYFrom;\n\n      expandedRange = [0, shiftHalf];\n      collapsedRange = [shiftHalf, translateYFrom + visiblePart / 4];\n      hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n      collapsed = translateYFrom > 0;\n      expanded = translateYFrom <= 0;\n      translateY = translateYFrom;\n    } else {\n      const headerHeight = modalState.headerElement.offsetHeight;\n      const height = contentHeight + headerHeight;\n\n      translateYFrom = 100 - height / modalState.innerElement.parentElement.offsetHeight * 100;\n      translateY = translateYFrom;\n\n      expandedRange = [translateY, translateY + 25];\n      collapsedRange = [translateY + 25, translateY + 25];\n      hiddenRange = [translateY + 25, translateY + 100];\n    }\n\n    // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n    if (modalState.expandable && translateY > prevTranslateY) {\n      translateY = 0;\n    }\n\n    modalState.expandedRange = expandedRange;\n    modalState.collapsedRange = collapsedRange;\n    modalState.hiddenRange = hiddenRange;\n    modalState.translateY = translateY;\n    modalState.translateYFrom = translateYFrom;\n    modalState.collapsed = collapsed;\n    modalState.expanded = expanded;\n  }\n\n  initCardModal(modalState: ModalsStateEntry, modalElement: HTMLElement) {\n    modalState.modalElement = modalElement;\n    modalState.innerElement = modalElement.querySelector('.ModalCard__in');\n\n    modalState.translateY = 0;\n  }\n\n  checkPageContentHeight() {\n    const activeModal = this.state.activeModal;\n\n    const modalElement = this.pickModal(activeModal);\n    if (modalElement) {\n      const modalState = this.modalsState[activeModal];\n\n      const prevModalState = { ...modalState };\n      this.initPageModal(modalState, modalElement);\n      const currentModalState = { ...modalState };\n\n      let needAnimate = false;\n\n      if (prevModalState.expandable === currentModalState.expandable) {\n        if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n          needAnimate = true;\n        }\n      } else {\n        needAnimate = true;\n      }\n\n      if (needAnimate) {\n        this.animateTranslate(modalState);\n        this.animatePageHeader(modalState);\n      }\n    }\n  }\n\n  updateModalHeight = () => {\n    const { activeModal, nextModal } = this.state;\n\n    const modalId = activeModal || nextModal;\n    const modalState = modalId ? this.modalsState[modalId] : undefined;\n\n    if (modalState && modalState.type === TYPE_PAGE && modalState.dynamicContentHeight) {\n      if (this.state.switching) {\n        this.waitTransitionFinish(modalState, () => {\n          requestAnimationFrame(() => this.checkPageContentHeight());\n        });\n      } else {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n  };\n\n  closeActiveModal() {\n    const { prevModal } = this.state;\n    if (!prevModal) {\n      return console.warn(`[ModalRoot.closeActiveModal] prevModal is ${prevModal}`);\n    }\n\n    const prevModalState = this.modalsState[prevModal];\n\n    this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n    this.animateTranslate(prevModalState, 100);\n    this.setMaskOpacity(prevModalState, 0);\n  }\n\n  onTouchMove = (e: TouchEvent) => {\n    if (this.state.switching) {\n      return;\n    }\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalState = this.modalsState[activeModal];\n\n    if (modalState.type === TYPE_PAGE) {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === TYPE_CARD) {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { shiftY, startT, originalEvent } = event;\n\n    const target = originalEvent.target as HTMLElement;\n\n    if (!event.isY) {\n      if (target.closest('.ModalPage')) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!target.closest('.ModalPage__in')) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartTime = startT;\n      modalState.touchStartContentScrollTop = modalState.contentElement.scrollTop;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0 ||\n      target.closest('.ModalPage__header')\n    ) {\n      originalEvent.preventDefault();\n      if (!expandable && shiftY < 0) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = shiftY / this.window.innerHeight * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform === ANDROID);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate(modalState.translateY + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY, startT } = event;\n    const target = originalEvent.target as HTMLElement;\n    if (target.closest('.ModalCard__container')) {\n      if (!this.state.touchDown) {\n        modalState.touchStartTime = startT;\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = shiftY / modalState.innerElement.offsetHeight * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform === ANDROID);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, modalState.translateY + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e: TouchEvent) => {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.modalsState[activeModal];\n\n    if (modalState.type === TYPE_PAGE) {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState.type === TYPE_CARD) {\n      return this.onCardTouchEnd(modalState);\n    }\n  };\n\n  onPageTouchEnd(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let next;\n\n    if (this.state.dragging) {\n      const shiftYEndPercent = (startY + shiftY) / this.window.innerHeight * 100;\n\n      let translateY = modalState.translateYCurrent;\n      const expectTranslateY = translateY / (Date.now() - modalState.touchStartTime.getTime()) * 240 * 0.6 * (modalState.touchShiftYPercent < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (numberInRange(translateY, modalState.expandedRange)) {\n        translateY = modalState.expandedRange[0];\n      } else if (numberInRange(translateY, modalState.collapsedRange)) {\n        translateY = modalState.translateYFrom;\n      } else if (numberInRange(translateY, modalState.hiddenRange)) {\n        translateY = 100;\n      } else {\n        translateY = modalState.translateYFrom;\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = translateY > 0 && translateY < shiftYEndPercent;\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.doCloseModal(modalState);\n      }\n\n      next = () => {\n        !modalState.hidden && this.animateTranslate(modalState);\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState({\n      touchDown: false,\n      dragging: false,\n    }, next);\n  }\n\n  onCardTouchEnd(modalState: ModalsStateEntry) {\n    let next;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent;\n\n      const expectTranslateY = translateY / (Date.now() - modalState.touchStartTime.getTime()) * 240 * 0.6 * (modalState.touchShiftYPercent < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.doCloseModal(modalState);\n      }\n\n      next = () => {\n        !modalState.hidden && this.animateTranslate(modalState);\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState({\n      touchDown: false,\n      dragging: false,\n    }, next);\n  }\n\n  onScroll = (e: SyntheticEvent) => {\n    const activeModal = this.state.activeModal;\n\n    const target = e.target as HTMLElement;\n\n    if (activeModal && target.closest('.ModalPage__content')) {\n      const modalState = this.modalsState[activeModal];\n      modalState.contentScrolled = true;\n\n      clearTimeout(modalState.contentScrollStopTimeout);\n\n      modalState.contentScrollStopTimeout = window.setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry, eventHandler: () => void) {\n    const eventName = transitionEvents.transitionEndEventName;\n\n    const onceHandler = () => {\n      modalState.innerElement.removeEventListener(eventName, onceHandler);\n      eventHandler();\n    };\n\n    modalState.innerElement.addEventListener(eventName, onceHandler);\n  }\n\n  switchPrevNext() {\n    const { prevModal, nextModal } = this.state;\n\n    const prevModalState = this.modalsState[prevModal];\n    const nextModalState = this.modalsState[nextModal];\n\n    if (!prevModalState && !nextModalState) {\n      return console.warn(`[ModalRoot.switchPrevNext] prevModal is ${prevModal}, nextModal is ${nextModal}`);\n    }\n\n    const prevIsPage = !!prevModalState && prevModalState.type === TYPE_PAGE;\n    const prevIsCard = !!prevModalState && prevModalState.type === TYPE_CARD;\n\n    const nextIsPage = !!nextModalState && nextModalState.type === TYPE_PAGE;\n    const nextIsCard = !!nextModalState && nextModalState.type === TYPE_CARD;\n\n    // Ждём полного скрытия предыдущей модалки\n    if (prevModalState && (nextIsCard || prevIsCard && nextIsPage)) {\n      this.waitTransitionFinish(prevModalState, () => {\n        this.activeTransitions += 1;\n        this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n        this.animateTranslate(nextModalState);\n      });\n\n      return this.animateTranslate(prevModalState, 100);\n    }\n\n    if (prevModalState && nextIsPage) {\n      this.activeTransitions += 1;\n      this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n\n      if (prevIsPage && prevModalState.translateY <= nextModalState.translateYFrom && !this.state.isBack) {\n        this.animateTranslate(prevModalState, nextModalState.translateYFrom + 10);\n      } else {\n        this.animateTranslate(prevModalState, 100);\n      }\n    }\n\n    this.activeTransitions += 1;\n    this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n    this.animateTranslate(nextModalState);\n  }\n\n  prevNextSwitchEndHandler = () => {\n    this.activeTransitions = Math.max(0, this.activeTransitions - 1);\n    if (this.activeTransitions > 0) {\n      return;\n    }\n\n    const activeModal = this.state.nextModal;\n\n    const newState: ModalRootState = {\n      prevModal: null,\n      nextModal: null,\n      visibleModals: [activeModal],\n      activeModal: activeModal,\n      animated: false,\n      switching: false,\n    };\n\n    if (!activeModal) {\n      newState.history = [];\n    }\n\n    this.setState(newState);\n  };\n\n  /* Анимирует сдивг модалки */\n  animateTranslate(modalState: ModalsStateEntry, currentPercent: number = null) {\n    if (currentPercent === null) {\n      currentPercent = modalState.translateY;\n    }\n\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this.frameIds[frameId]);\n\n    this.frameIds[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translateY(${currentPercent}%)`);\n\n      if (modalState.type === TYPE_PAGE && modalState.footerElement) {\n        const footerHeight = modalState.footerElement.offsetHeight;\n        const factor = modalState.innerElement.offsetHeight * (currentPercent / 100);\n\n        setTransformStyle(modalState.footerElement, `translateY(calc(${footerHeight}px * -${factor / footerHeight}))`);\n      }\n    });\n\n    if (modalState.type === TYPE_PAGE && modalState.expandable) {\n      this.animatePageHeader(modalState, currentPercent);\n    }\n  }\n\n  /* Анимирует тень шапки */\n  animatePageHeader(modalState: ModalsStateEntry, currentPercent: number = null) {\n    if (currentPercent === null) {\n      currentPercent = modalState.translateY;\n    }\n    const headerOpenPercent = currentPercent < 15 ? Math.max(0, 15 - currentPercent) / 15 : 0;\n\n    requestAnimationFrame(() => {\n      const headerShadow: HTMLElement = modalState.headerElement.querySelector('.ModalPageHeader__shadow');\n      if (headerShadow) {\n        headerShadow.style.opacity = headerOpenPercent.toString();\n      }\n    });\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number = null) {\n    if (forceOpacity === null && this.state.history[0] !== modalState.id) {\n      return;\n    }\n\n    cancelAnimationFrame(this.maskAnimationFrame);\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY, translateYCurrent } = modalState;\n\n        const opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(0, Math.min(100, opacity)).toString();\n      }\n    });\n  }\n\n  /**\n   * Закрывает текущую модалку\n   */\n  triggerActiveModalClose() {\n    const activeModalState = this.modalsState[this.state.activeModal];\n    if (activeModalState) {\n      this.doCloseModal(activeModalState);\n    }\n  }\n\n  private readonly doCloseModal = (modalState: ModalsStateEntry) => {\n    if (isFunction(modalState.onClose)) {\n      modalState.onClose();\n    } else if (isFunction(this.props.onClose)) {\n      this.props.onClose(modalState.id);\n    } else {\n      console.error('[ModalRoot] onClose is undefined');\n    }\n  };\n\n  /**\n   * По клику на полупрозрачный черный фон нужно закрыть текущую модалку\n   */\n  onMaskClick = () => {\n    if (!this.state.switching) {\n      this.triggerActiveModalClose();\n    }\n  };\n\n  render() {\n    const { prevModal, activeModal, nextModal, visibleModals, animated, touchDown, dragging, switching } = this.state;\n\n    if (!activeModal && !prevModal && !nextModal && !animated) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <ModalRootContext.Provider value={this.modalRootContext}>\n          <Touch\n            className={classNames(getClassName('ModalRoot', this.props.platform), {\n              'ModalRoot--vkapps': this.webviewType === 'vkapps',\n              'ModalRoot--touched': touchDown,\n              'ModalRoot--switching': switching,\n            })}\n            onMove={this.onTouchMove}\n            onEnd={this.onTouchEnd}\n            onScroll={this.onScroll}\n          >\n            <div\n              className=\"ModalRoot__mask\"\n              onClick={this.onMaskClick}\n              ref={this.maskElementRef}\n            />\n            <div className=\"ModalRoot__viewport\">\n              {this.modals.map((Modal: ReactElement) => {\n                const modalId = Modal.props.id;\n                if (!visibleModals.includes(Modal.props.id)) {\n                  return null;\n                }\n                const modalState = { ...this.modalsState[modalId] };\n\n                const isPage = modalState.type === TYPE_PAGE;\n                const key = `modal-${modalId}`;\n\n                return (\n                  <div\n                    key={key}\n                    id={key}\n                    className={classNames('ModalRoot__modal', {\n                      'ModalRoot__modal--active': modalId === activeModal,\n                      'ModalRoot__modal--prev': modalId === prevModal,\n                      'ModalRoot__modal--next': modalId === nextModal,\n\n                      'ModalRoot__modal--dragging': dragging,\n\n                      'ModalRoot__modal--expandable': isPage && modalState.expandable,\n                      'ModalRoot__modal--expanded': isPage && modalState.expanded,\n                      'ModalRoot__modal--collapsed': isPage && modalState.collapsed,\n                    })}\n                  >{Modal}</div>\n                );\n              })}\n            </div>\n          </Touch>\n        </ModalRootContext.Provider>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport default withPlatform(ModalRoot);\n"],"file":"ModalRoot.js"}
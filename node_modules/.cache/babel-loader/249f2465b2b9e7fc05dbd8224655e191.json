{"ast":null,"code":"import _extends from \"@babel/runtime/helpers/extends\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/objectWithoutProperties\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/assertThisInitialized\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\n\nfunction _createSuper(Derived) {\n  return function () {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (_isNativeReflectConstruct()) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nimport React, { PureComponent } from 'react';\nimport PropTypes from 'prop-types';\nimport Touch from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport FixedLayout from '../FixedLayout/FixedLayout';\nimport classNames from '../../lib/classNames';\nimport { IOS, ANDROID } from '../../lib/platform';\nimport getClassName from '../../helpers/getClassName';\nimport PullToRefreshSpinner from './PullToRefreshSpinner';\nimport withPlatform from '../../hoc/withPlatform';\nimport { canUseDOM } from '../../lib/dom';\n\nfunction cancelEvent(event) {\n  if (!event) {\n    return false;\n  }\n\n  while (event.originalEvent) {\n    event = event.originalEvent;\n  }\n\n  if (event.preventDefault) {\n    event.preventDefault();\n  }\n\n  if (event.stopPropagation) {\n    event.stopPropagation();\n  }\n\n  return false;\n}\n\nvar PullToRefresh = /*#__PURE__*/function (_PureComponent) {\n  _inherits(PullToRefresh, _PureComponent);\n\n  var _super = _createSuper(PullToRefresh);\n\n  function PullToRefresh(props) {\n    var _this;\n\n    _classCallCheck(this, PullToRefresh);\n\n    _this = _super.call(this, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"params\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"contentRef\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"onTouchStart\", function (e) {\n      if (_this.state.refreshing) {\n        cancelEvent(e);\n      }\n\n      _this.setState({\n        touchDown: true\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onWindowTouchMove\", function (event) {\n      if (_this.state.refreshing) {\n        event.preventDefault();\n        event.stopPropagation();\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onTouchMove\", function (e) {\n      var isY = e.isY,\n          shiftY = e.shiftY;\n      var _this$params = _this.params,\n          start = _this$params.start,\n          max = _this$params.max;\n      var pageYOffset = _this.window.pageYOffset;\n      var _this$state = _this.state,\n          refreshing = _this$state.refreshing,\n          watching = _this$state.watching,\n          touchDown = _this$state.touchDown;\n\n      if (watching && touchDown) {\n        cancelEvent(e);\n        var positionMultiplier = _this.params.positionMultiplier;\n        var shift = Math.max(0, shiftY - _this.state.touchY);\n        var currentY = Math.max(start, Math.min(_this.params.maxY, start + shift * positionMultiplier));\n        var progress = currentY > -10 ? Math.abs((currentY + 10) / max) * 80 : 0;\n\n        _this.setState({\n          spinnerY: currentY,\n          spinnerProgress: Math.min(80, Math.max(0, progress)),\n          canRefresh: progress > 80,\n          contentShift: (currentY + 10) * 2.3\n        });\n\n        if (progress > 85 && !refreshing && _this.props.platform === IOS) {\n          _this.runRefreshing();\n        }\n      } else if (isY && pageYOffset === 0 && shiftY > 0 && !refreshing && touchDown) {\n        cancelEvent(e);\n\n        _this.setState({\n          watching: true,\n          touchY: shiftY,\n          spinnerY: start,\n          spinnerProgress: 0\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onTouchEnd\", function () {\n      var _this$state2 = _this.state,\n          refreshing = _this$state2.refreshing,\n          canRefresh = _this$state2.canRefresh,\n          refreshingFinished = _this$state2.refreshingFinished;\n\n      _this.setState({\n        watching: false,\n        touchDown: false\n      }, function () {\n        if (canRefresh && !refreshing) {\n          _this.runRefreshing();\n        } else if (refreshing && refreshingFinished) {\n          _this.resetRefreshingState();\n        } else {\n          _this.setState({\n            spinnerY: refreshing ? _this.params.refreshing : _this.params.start,\n            spinnerProgress: 0,\n            contentShift: 0\n          });\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onRefreshingFinish\", function () {\n      _this.setState({\n        refreshingFinished: true\n      }, function () {\n        !_this.state.touchDown && _this.resetRefreshingState();\n      });\n    });\n\n    _this.params = {\n      start: props.platform === ANDROID ? -45 : -10,\n      max: props.platform === ANDROID ? 80 : 50,\n      maxY: props.platform === ANDROID ? 80 : 400,\n      refreshing: props.platform === ANDROID ? 50 : 36,\n      positionMultiplier: props.platform === ANDROID ? 1 : 0.21\n    };\n    _this.state = {\n      watching: false,\n      refreshing: false,\n      canRefresh: false,\n      touchDown: false,\n      refreshingFinished: false,\n      touchY: 0,\n      spinnerY: _this.params.start,\n      spinnerProgress: 0,\n      contentShift: 0\n    };\n    _this.contentRef = React.createRef();\n    return _this;\n  }\n\n  _createClass(PullToRefresh, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      if (canUseDOM) {\n        this.document.addEventListener('touchmove', this.onWindowTouchMove, {\n          cancelable: true,\n          passive: false\n        });\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      // Здесь нужен последний аргумент с такими же параметрами, потому что\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      if (canUseDOM) {\n        this.document.removeEventListener('touchmove', this.onWindowTouchMove, {\n          cancelable: true,\n          passive: false\n        });\n      }\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      if (prevProps.isFetching && !this.props.isFetching) {\n        this.onRefreshingFinish();\n      }\n    }\n  }, {\n    key: \"runRefreshing\",\n    value: function runRefreshing() {\n      if (!this.state.refreshing && this.props.onRefresh) {\n        this.setState({\n          refreshing: true,\n          spinnerY: this.props.platform === ANDROID ? this.params.refreshing : this.state.spinnerY\n        });\n        this.props.onRefresh();\n      }\n    }\n  }, {\n    key: \"resetRefreshingState\",\n    value: function resetRefreshingState() {\n      this.setState({\n        watching: false,\n        canRefresh: false,\n        refreshing: false,\n        refreshingFinished: false,\n        spinnerY: this.params.start,\n        spinnerProgress: 0,\n        contentShift: 0\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props = this.props,\n          children = _this$props.children,\n          className = _this$props.className,\n          onRefresh = _this$props.onRefresh,\n          isFetching = _this$props.isFetching,\n          platform = _this$props.platform,\n          restProps = _objectWithoutProperties(_this$props, [\"children\", \"className\", \"onRefresh\", \"isFetching\", \"platform\"]);\n\n      var _this$state3 = this.state,\n          watching = _this$state3.watching,\n          refreshing = _this$state3.refreshing,\n          spinnerY = _this$state3.spinnerY,\n          spinnerProgress = _this$state3.spinnerProgress,\n          canRefresh = _this$state3.canRefresh,\n          touchDown = _this$state3.touchDown,\n          contentShift = _this$state3.contentShift;\n      var spinnerTransform = \"translate3d(0, \".concat(spinnerY, \"px, 0)\");\n      var contentTransform = '';\n\n      if (platform === IOS && refreshing && !touchDown) {\n        contentTransform = 'translate3d(0, 100px, 0)';\n      } else if (platform === IOS && contentShift) {\n        contentTransform = \"translate3d(0, \".concat(contentShift, \"px, 0)\");\n      }\n\n      return /*#__PURE__*/React.createElement(TouchRootContext.Provider, {\n        value: true\n      }, /*#__PURE__*/React.createElement(Touch, _extends({}, restProps, {\n        onStart: this.onTouchStart,\n        onMove: this.onTouchMove,\n        onEnd: this.onTouchEnd,\n        className: classNames(getClassName('PullToRefresh', platform), className, {\n          'PullToRefresh--watching': watching,\n          'PullToRefresh--refreshing': refreshing\n        })\n      }), /*#__PURE__*/React.createElement(FixedLayout, {\n        className: \"PullToRefresh__controls\"\n      }, /*#__PURE__*/React.createElement(PullToRefreshSpinner, {\n        style: {\n          transform: spinnerTransform,\n          WebkitTransform: spinnerTransform,\n          opacity: watching || refreshing || canRefresh ? 1 : 0\n        },\n        on: refreshing,\n        progress: refreshing ? null : spinnerProgress\n      })), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"PullToRefresh__content\",\n        ref: this.contentRef,\n        style: {\n          transform: contentTransform,\n          WebkitTransform: contentTransform\n        }\n      }, children)));\n    }\n  }, {\n    key: \"document\",\n    get: function get() {\n      return this.context.document || document;\n    }\n  }, {\n    key: \"window\",\n    get: function get() {\n      return this.context.window || window;\n    }\n  }]);\n\n  return PullToRefresh;\n}(PureComponent);\n\n_defineProperty(PullToRefresh, \"contextTypes\", {\n  window: PropTypes.any,\n  document: PropTypes.any\n});\n\nexport default withPlatform(PullToRefresh);","map":{"version":3,"sources":["../../../../src/components/PullToRefresh/PullToRefresh.tsx"],"names":["event","PullToRefresh","PureComponent","start","props","max","maxY","refreshing","positionMultiplier","watching","canRefresh","touchDown","refreshingFinished","touchY","spinnerY","spinnerProgress","contentShift","React","window","PropTypes","document","any","cancelable","passive","prevProps","cancelEvent","isY","shiftY","e","pageYOffset","shift","Math","currentY","progress","children","className","onRefresh","isFetching","platform","restProps","spinnerTransform","contentTransform","classNames","getClassName","transform","WebkitTransform","opacity","withPlatform"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAA,KAAA,IAAA,aAAA,QAAA,OAAA;AACA,OAAA,SAAA,MAAA,YAAA;AACA,OAAA,KAAA,MAAA,gBAAA;AACA,OAAA,gBAAA,MAAA,uBAAA;AACA,OAAA,WAAA,MAAA,4BAAA;AACA,OAAA,UAAA,MAAA,sBAAA;AACA,SAAA,GAAA,EAAA,OAAA,QAAA,oBAAA;AACA,OAAA,YAAA,MAAA,4BAAA;AACA,OAAA,oBAAA,MAAA,wBAAA;AACA,OAAA,YAAA,MAAA,wBAAA;AAEA,SAAA,SAAA,QAAA,eAAA;;AA0CA,SAAA,WAAA,CAAA,KAAA,EAAiC;AAC/B,MAAI,CAAJ,KAAA,EAAY;AACV,WAAA,KAAA;AACD;;AACD,SAAOA,KAAK,CAAZ,aAAA,EAA4B;AAC1BA,IAAAA,KAAK,GAAGA,KAAK,CAAbA,aAAAA;AACD;;AACD,MAAIA,KAAK,CAAT,cAAA,EAA0B;AACxBA,IAAAA,KAAK,CAALA,cAAAA;AACD;;AACD,MAAIA,KAAK,CAAT,eAAA,EAA2B;AACzBA,IAAAA,KAAK,CAALA,eAAAA;AACD;;AACD,SAAA,KAAA;AACD;;IAEKC,a;;;;;AACJ,WAAA,aAAA,CAAA,KAAA,EAAuC;AAAA,QAAA,KAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,aAAA,CAAA;;AACrC,IAAA,KAAA,GAAA,MAAA,CAAA,IAAA,CAAA,IAAA,EAAA,KAAA,CAAA;;AADqC,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,QAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,YAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,cAAA,EAyEL,UAAA,CAAA,EAAmB;AACnD,UAAI,KAAA,CAAA,KAAA,CAAJ,UAAA,EAA2B;AACzBwB,QAAAA,WAAW,CAAXA,CAAW,CAAXA;AACD;;AACD,MAAA,KAAA,CAAA,QAAA,CAAc;AAAEd,QAAAA,SAAS,EAAE;AAAb,OAAd;AA7EqC,KAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,mBAAA,EAgFJ,UAAA,KAAA,EAAkB;AACnD,UAAI,KAAA,CAAA,KAAA,CAAJ,UAAA,EAA2B;AACzBX,QAAAA,KAAK,CAALA,cAAAA;AACAA,QAAAA,KAAK,CAALA,eAAAA;AACD;AApFoC,KAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,aAAA,EAuFN,UAAA,CAAA,EAAmB;AAAA,UAC1C0B,GAD0C,GAC1BE,CAD0B,CAAA,GAAA;AAAA,UACrCD,MADqC,GAC1BC,CAD0B,CAAA,MAAA;AAAA,UAAA,YAAA,GAE3B,KAAA,CAF2B,MAAA;AAAA,UAE1CzB,KAF0C,GAAA,YAAA,CAAA,KAAA;AAAA,UAEnCE,GAFmC,GAAA,YAAA,CAAA,GAAA;AAGlD,UAAMwB,WAAW,GAAG,KAAA,CAAA,MAAA,CAApB,WAAA;AAHkD,UAAA,WAAA,GAKN,KAAA,CALM,KAAA;AAAA,UAK1CtB,UAL0C,GAAA,WAAA,CAAA,UAAA;AAAA,UAK9BE,QAL8B,GAAA,WAAA,CAAA,QAAA;AAAA,UAKpBE,SALoB,GAAA,WAAA,CAAA,SAAA;;AAOlD,UAAIF,QAAQ,IAAZ,SAAA,EAA2B;AACzBgB,QAAAA,WAAW,CAAXA,CAAW,CAAXA;AADyB,YAGjBjB,kBAHiB,GAGM,KAAA,CAHN,MAGM,CAHN,kBAAA;AAKzB,YAAMsB,KAAK,GAAGC,IAAI,CAAJA,GAAAA,CAAAA,CAAAA,EAAYJ,MAAM,GAAG,KAAA,CAAA,KAAA,CAAnC,MAAcI,CAAd;AAEA,YAAMC,QAAQ,GAAGD,IAAI,CAAJA,GAAAA,CAAAA,KAAAA,EAAgBA,IAAI,CAAJA,GAAAA,CAAS,KAAA,CAAA,MAAA,CAATA,IAAAA,EAA2B5B,KAAK,GAAG2B,KAAK,GAAzE,kBAAiCC,CAAhBA,CAAjB;AACA,YAAME,QAAQ,GAAGD,QAAQ,GAAG,CAAXA,EAAAA,GAAiBD,IAAI,CAAJA,GAAAA,CAAS,CAACC,QAAQ,GAAT,EAAA,IAATD,GAAAA,IAAjBC,EAAAA,GAAjB,CAAA;;AAEA,QAAA,KAAA,CAAA,QAAA,CAAc;AACZlB,UAAAA,QAAQ,EADI,QAAA;AAEZC,UAAAA,eAAe,EAAEgB,IAAI,CAAJA,GAAAA,CAAAA,EAAAA,EAAaA,IAAI,CAAJA,GAAAA,CAAAA,CAAAA,EAFlB,QAEkBA,CAAbA,CAFL;AAGZrB,UAAAA,UAAU,EAAEuB,QAAQ,GAHR,EAAA;AAIZjB,UAAAA,YAAY,EAAE,CAACgB,QAAQ,GAAT,EAAA,IAAkB;AAJpB,SAAd;;AAOA,YAAIC,QAAQ,GAARA,EAAAA,IAAiB,CAAjBA,UAAAA,IAAgC,KAAA,CAAA,KAAA,CAAA,QAAA,KAApC,GAAA,EAAiE;AAC/D,UAAA,KAAA,CAAA,aAAA;AACD;AAnBH,OAAA,MAoBO,IAAIP,GAAG,IAAIG,WAAW,KAAlBH,CAAAA,IAA4BC,MAAM,GAAlCD,CAAAA,IAA0C,CAA1CA,UAAAA,IAAJ,SAAA,EAAwE;AAC7ED,QAAAA,WAAW,CAAXA,CAAW,CAAXA;;AAEA,QAAA,KAAA,CAAA,QAAA,CAAc;AACZhB,UAAAA,QAAQ,EADI,IAAA;AAEZI,UAAAA,MAAM,EAFM,MAAA;AAGZC,UAAAA,QAAQ,EAHI,KAAA;AAIZC,UAAAA,eAAe,EAAE;AAJL,SAAd;AAMD;AA3HoC,KAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,YAAA,EA8HZ,YAAM;AAAA,UAAA,YAAA,GACwB,KAAA,CADxB,KAAA;AAAA,UACvBR,UADuB,GAAA,YAAA,CAAA,UAAA;AAAA,UACXG,UADW,GAAA,YAAA,CAAA,UAAA;AAAA,UACCE,kBADD,GAAA,YAAA,CAAA,kBAAA;;AAG/B,MAAA,KAAA,CAAA,QAAA,CAAc;AACZH,QAAAA,QAAQ,EADI,KAAA;AAEZE,QAAAA,SAAS,EAAE;AAFC,OAAd,EAGG,YAAM;AACP,YAAID,UAAU,IAAI,CAAlB,UAAA,EAA+B;AAC7B,UAAA,KAAA,CAAA,aAAA;AADF,SAAA,MAEO,IAAIH,UAAU,IAAd,kBAAA,EAAsC;AAC3C,UAAA,KAAA,CAAA,oBAAA;AADK,SAAA,MAEA;AACL,UAAA,KAAA,CAAA,QAAA,CAAc;AACZO,YAAAA,QAAQ,EAAEP,UAAU,GAAG,KAAA,CAAA,MAAA,CAAH,UAAA,GAA4B,KAAA,CAAA,MAAA,CADpC,KAAA;AAEZQ,YAAAA,eAAe,EAFH,CAAA;AAGZC,YAAAA,YAAY,EAAE;AAHF,WAAd;AAKD;AAdH,OAAA;AAjIqC,KAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,sBAAA,CAAA,KAAA,CAAA,EAAA,oBAAA,EA8JJ,YAAM;AACvC,MAAA,KAAA,CAAA,QAAA,CAAc;AACZJ,QAAAA,kBAAkB,EAAE;AADR,OAAd,EAEG,YAAM;AACP,SAAC,KAAA,CAAA,KAAA,CAAD,SAAA,IAAyB,KAAA,CAAzB,oBAAyB,EAAzB;AAHF,OAAA;AA/JqC,KAAA,CAAA;;AAGrC,IAAA,KAAA,CAAA,MAAA,GAAc;AACZT,MAAAA,KAAK,EAAEC,KAAK,CAALA,QAAAA,KAAAA,OAAAA,GAA6B,CAA7BA,EAAAA,GAAmC,CAD9B,EAAA;AAEZC,MAAAA,GAAG,EAAED,KAAK,CAALA,QAAAA,KAAAA,OAAAA,GAAAA,EAAAA,GAFO,EAAA;AAGZE,MAAAA,IAAI,EAAEF,KAAK,CAALA,QAAAA,KAAAA,OAAAA,GAAAA,EAAAA,GAHM,GAAA;AAIZG,MAAAA,UAAU,EAAEH,KAAK,CAALA,QAAAA,KAAAA,OAAAA,GAAAA,EAAAA,GAJA,EAAA;AAMZI,MAAAA,kBAAkB,EAAEJ,KAAK,CAALA,QAAAA,KAAAA,OAAAA,GAAAA,CAAAA,GAAiC;AANzC,KAAd;AASA,IAAA,KAAA,CAAA,KAAA,GAAa;AACXK,MAAAA,QAAQ,EADG,KAAA;AAEXF,MAAAA,UAAU,EAFC,KAAA;AAGXG,MAAAA,UAAU,EAHC,KAAA;AAKXC,MAAAA,SAAS,EALE,KAAA;AAMXC,MAAAA,kBAAkB,EANP,KAAA;AAQXC,MAAAA,MAAM,EARK,CAAA;AASXC,MAAAA,QAAQ,EAAE,KAAA,CAAA,MAAA,CATC,KAAA;AAUXC,MAAAA,eAAe,EAVJ,CAAA;AAWXC,MAAAA,YAAY,EAAE;AAXH,KAAb;AAcA,IAAA,KAAA,CAAA,UAAA,GAAkBC,KAAK,CAAvB,SAAkBA,EAAlB;AA1BqC,WAAA,KAAA;AA2BtC;;;;wCAmBmB;AAClB,UAAA,SAAA,EAAe;AACb,aAAA,QAAA,CAAA,gBAAA,CAAA,WAAA,EAA4C,KAA5C,iBAAA,EAAoE;AAClEK,UAAAA,UAAU,EADwD,IAAA;AAElEC,UAAAA,OAAO,EAAE;AAFyD,SAApE;AAID;AACF;;;2CAEsB;AACrB;AACA;AACA;AACA,UAAA,SAAA,EAAe;AACb,aAAA,QAAA,CAAA,mBAAA,CAAA,WAAA,EAA+C,KAA/C,iBAAA,EAAuE;AACrED,UAAAA,UAAU,EAD2D,IAAA;AAErEC,UAAAA,OAAO,EAAE;AAF4D,SAAvE;AAID;AACF;;;uCAEkBC,S,EAA+B;AAChD,UAAIA,SAAS,CAATA,UAAAA,IAAwB,CAAC,KAAA,KAAA,CAA7B,UAAA,EAAoD;AAClD,aAAA,kBAAA;AACD;AACF;;;oCA4Ee;AACd,UAAI,CAAC,KAAA,KAAA,CAAD,UAAA,IAA0B,KAAA,KAAA,CAA9B,SAAA,EAAoD;AAClD,aAAA,QAAA,CAAc;AACZjB,UAAAA,UAAU,EADE,IAAA;AAEZO,UAAAA,QAAQ,EAAE,KAAA,KAAA,CAAA,QAAA,KAAA,OAAA,GAAkC,KAAA,MAAA,CAAlC,UAAA,GAA2D,KAAA,KAAA,CAAWA;AAFpE,SAAd;AAKA,aAAA,KAAA,CAAA,SAAA;AACD;AACF;;;2CAUsB;AACrB,WAAA,QAAA,CAAc;AACZL,QAAAA,QAAQ,EADI,KAAA;AAEZC,QAAAA,UAAU,EAFE,KAAA;AAGZH,QAAAA,UAAU,EAHE,KAAA;AAIZK,QAAAA,kBAAkB,EAJN,KAAA;AAKZE,QAAAA,QAAQ,EAAE,KAAA,MAAA,CALE,KAAA;AAMZC,QAAAA,eAAe,EANH,CAAA;AAOZC,QAAAA,YAAY,EAAE;AAPF,OAAd;AASD;;;6BAEQ;AAAA,UAAA,WAAA,GACwE,KADxE,KAAA;AAAA,UACCkB,QADD,GAAA,WAAA,CAAA,QAAA;AAAA,UACWC,SADX,GAAA,WAAA,CAAA,SAAA;AAAA,UACsBC,SADtB,GAAA,WAAA,CAAA,SAAA;AAAA,UACiCC,UADjC,GAAA,WAAA,CAAA,UAAA;AAAA,UAC6CC,QAD7C,GAAA,WAAA,CAAA,QAAA;AAAA,UAC0DC,SAD1D,GAAA,wBAAA,CAAA,WAAA,EAAA,CAAA,UAAA,EAAA,WAAA,EAAA,WAAA,EAAA,YAAA,EAAA,UAAA,CAAA,CAAA;;AAAA,UAAA,YAAA,GAE0F,KAF1F,KAAA;AAAA,UAEC9B,QAFD,GAAA,YAAA,CAAA,QAAA;AAAA,UAEWF,UAFX,GAAA,YAAA,CAAA,UAAA;AAAA,UAEuBO,QAFvB,GAAA,YAAA,CAAA,QAAA;AAAA,UAEiCC,eAFjC,GAAA,YAAA,CAAA,eAAA;AAAA,UAEkDL,UAFlD,GAAA,YAAA,CAAA,UAAA;AAAA,UAE8DC,SAF9D,GAAA,YAAA,CAAA,SAAA;AAAA,UAEyEK,YAFzE,GAAA,YAAA,CAAA,YAAA;AAIP,UAAMwB,gBAAgB,GAAA,kBAAA,MAAA,CAAA,QAAA,EAAtB,QAAsB,CAAtB;AACA,UAAIC,gBAAgB,GAApB,EAAA;;AAEA,UAAIH,QAAQ,KAARA,GAAAA,IAAAA,UAAAA,IAAkC,CAAtC,SAAA,EAAkD;AAChDG,QAAAA,gBAAgB,GAAhBA,0BAAAA;AADF,OAAA,MAEO,IAAIH,QAAQ,KAARA,GAAAA,IAAJ,YAAA,EAAsC;AAC3CG,QAAAA,gBAAgB,GAAA,kBAAA,MAAA,CAAA,YAAA,EAAhBA,QAAgB,CAAhBA;AACD;;AAED,aAAA,aACE,KAAA,CAAA,aAAA,CAAC,gBAAD,CAAA,QAAA,EAAA;AAA2B,QAAA,KAAK,EAAE;AAAlC,OAAA,EAAA,aACE,KAAA,CAAA,aAAA,CAAA,KAAA,EAAA,QAAA,CAAA,EAAA,EAAA,SAAA,EAAA;AAEE,QAAA,OAAO,EAAE,KAFX,YAAA;AAGE,QAAA,MAAM,EAAE,KAHV,WAAA;AAIE,QAAA,KAAK,EAAE,KAJT,UAAA;AAKE,QAAA,SAAS,EAAEC,UAAU,CAACC,YAAY,CAAA,eAAA,EAAb,QAAa,CAAb,EAAA,SAAA,EAAqD;AACxE,qCADwE,QAAA;AAExE,uCAA6BpC;AAF2C,SAArD;AALvB,OAAA,CAAA,EAAA,aAUE,KAAA,CAAA,aAAA,CAAA,WAAA,EAAA;AAAa,QAAA,SAAS,EAAC;AAAvB,OAAA,EAAA,aACE,KAAA,CAAA,aAAA,CAAA,oBAAA,EAAA;AACE,QAAA,KAAK,EAAE;AACLqC,UAAAA,SAAS,EADJ,gBAAA;AAELC,UAAAA,eAAe,EAFV,gBAAA;AAGLC,UAAAA,OAAO,EAAErC,QAAQ,IAARA,UAAAA,IAAAA,UAAAA,GAAAA,CAAAA,GAA2C;AAH/C,SADT;AAME,QAAA,EAAE,EANJ,UAAA;AAOE,QAAA,QAAQ,EAAEF,UAAU,GAAA,IAAA,GAAUQ;AAPhC,OAAA,CADF,CAVF,EAAA,aAsBE,KAAA,CAAA,aAAA,CAAA,KAAA,EAAA;AACE,QAAA,SAAS,EADX,wBAAA;AAEE,QAAA,GAAG,EAAE,KAFP,UAAA;AAGE,QAAA,KAAK,EAAE;AACL6B,UAAAA,SAAS,EADJ,gBAAA;AAELC,UAAAA,eAAe,EAAEJ;AAFZ;AAHT,OAAA,EAxBN,QAwBM,CAtBF,CADF,CADF;AAqCD;;;wBA9Lc;AACb,aAAO,KAAA,OAAA,CAAA,QAAA,IAAP,QAAA;AACD;;;wBAEY;AACX,aAAO,KAAA,OAAA,CAAA,MAAA,IAAP,MAAA;AACD;;;;EA7CyBvC,a;;gBAAtBD,a,kBAkCwC;AAC1CiB,EAAAA,MAAM,EAAEC,SAAS,CADyB,GAAA;AAE1CC,EAAAA,QAAQ,EAAED,SAAS,CAACE;AAFsB,C;;AAsM9C,eAAe0B,YAAY,CAA3B,aAA2B,CAA3B","sourcesContent":["import React, { PureComponent, RefObject } from 'react';\nimport PropTypes, { Requireable } from 'prop-types';\nimport Touch, { TouchProps, TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport FixedLayout from '../FixedLayout/FixedLayout';\nimport classNames from '../../lib/classNames';\nimport { IOS, ANDROID } from '../../lib/platform';\nimport getClassName from '../../helpers/getClassName';\nimport PullToRefreshSpinner from './PullToRefreshSpinner';\nimport withPlatform from '../../hoc/withPlatform';\nimport { HasPlatform } from '../../types';\nimport { canUseDOM } from '../../lib/dom';\n\nexport interface PullToRefreshProps extends TouchProps, HasPlatform {\n  /**\n   * Будет вызвана для обновления контента\n   */\n  onRefresh(): void;\n  /**\n   * Определяет, выполняется ли обновление. Для скрытия спиннера после получения контента необходимо передать `false`\n   */\n  isFetching?: boolean;\n}\n\nexport interface PullToRefreshState {\n  watching: boolean;\n  refreshing: boolean;\n  canRefresh: boolean;\n\n  touchDown: boolean;\n  refreshingFinished: boolean;\n\n  touchY: number;\n  spinnerY: PullToRefreshParams['start'];\n  spinnerProgress: number;\n  contentShift: number;\n}\n\nexport interface PullToRefreshContext {\n  document: Requireable<{}>;\n  window: Requireable<{}>;\n}\n\nexport interface PullToRefreshParams {\n  start: number;\n  max: number;\n  maxY: number;\n  refreshing: number;\n  positionMultiplier: number;\n}\n\nexport type TouchEventHandler = (event: TouchEvent) => void;\n\nfunction cancelEvent(event: any) {\n  if (!event) {\n    return false;\n  }\n  while (event.originalEvent) {\n    event = event.originalEvent;\n  }\n  if (event.preventDefault) {\n    event.preventDefault();\n  }\n  if (event.stopPropagation) {\n    event.stopPropagation();\n  }\n  return false;\n}\n\nclass PullToRefresh extends PureComponent<PullToRefreshProps, PullToRefreshState> {\n  constructor(props: PullToRefreshProps) {\n    super(props);\n\n    this.params = {\n      start: props.platform === ANDROID ? -45 : -10,\n      max: props.platform === ANDROID ? 80 : 50,\n      maxY: props.platform === ANDROID ? 80 : 400,\n      refreshing: props.platform === ANDROID ? 50 : 36,\n\n      positionMultiplier: props.platform === ANDROID ? 1 : 0.21,\n    };\n\n    this.state = {\n      watching: false,\n      refreshing: false,\n      canRefresh: false,\n\n      touchDown: false,\n      refreshingFinished: false,\n\n      touchY: 0,\n      spinnerY: this.params.start,\n      spinnerProgress: 0,\n      contentShift: 0,\n    };\n\n    this.contentRef = React.createRef();\n  }\n\n  params: PullToRefreshParams;\n\n  contentRef: RefObject<HTMLDivElement>;\n\n  static contextTypes: PullToRefreshContext = {\n    window: PropTypes.any,\n    document: PropTypes.any,\n  };\n\n  get document() {\n    return this.context.document || document;\n  }\n\n  get window() {\n    return this.context.window || window;\n  }\n\n  componentDidMount() {\n    if (canUseDOM) {\n      this.document.addEventListener('touchmove', this.onWindowTouchMove, {\n        cancelable: true,\n        passive: false,\n      });\n    }\n  }\n\n  componentWillUnmount() {\n    // Здесь нужен последний аргумент с такими же параметрами, потому что\n    // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n    // https://github.com/VKCOM/VKUI/issues/444\n    if (canUseDOM) {\n      this.document.removeEventListener('touchmove', this.onWindowTouchMove, {\n        cancelable: true,\n        passive: false,\n      });\n    }\n  }\n\n  componentDidUpdate(prevProps: PullToRefreshProps) {\n    if (prevProps.isFetching && !this.props.isFetching) {\n      this.onRefreshingFinish();\n    }\n  }\n\n  onTouchStart: TouchEventHandler = (e: TouchEvent) => {\n    if (this.state.refreshing) {\n      cancelEvent(e);\n    }\n    this.setState({ touchDown: true });\n  };\n\n  onWindowTouchMove: EventListener = (event: Event) => {\n    if (this.state.refreshing) {\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  onTouchMove: TouchEventHandler = (e: TouchEvent) => {\n    const { isY, shiftY } = e;\n    const { start, max } = this.params;\n    const pageYOffset = this.window.pageYOffset;\n\n    const { refreshing, watching, touchDown } = this.state;\n\n    if (watching && touchDown) {\n      cancelEvent(e);\n\n      const { positionMultiplier } = this.params;\n\n      const shift = Math.max(0, shiftY - this.state.touchY);\n\n      const currentY = Math.max(start, Math.min(this.params.maxY, start + shift * positionMultiplier));\n      const progress = currentY > -10 ? Math.abs((currentY + 10) / max) * 80 : 0;\n\n      this.setState({\n        spinnerY: currentY,\n        spinnerProgress: Math.min(80, Math.max(0, progress)),\n        canRefresh: progress > 80,\n        contentShift: (currentY + 10) * 2.3,\n      });\n\n      if (progress > 85 && !refreshing && this.props.platform === IOS) {\n        this.runRefreshing();\n      }\n    } else if (isY && pageYOffset === 0 && shiftY > 0 && !refreshing && touchDown) {\n      cancelEvent(e);\n\n      this.setState({\n        watching: true,\n        touchY: shiftY,\n        spinnerY: start,\n        spinnerProgress: 0,\n      });\n    }\n  };\n\n  onTouchEnd: VoidFunction = () => {\n    const { refreshing, canRefresh, refreshingFinished } = this.state;\n\n    this.setState({\n      watching: false,\n      touchDown: false,\n    }, () => {\n      if (canRefresh && !refreshing) {\n        this.runRefreshing();\n      } else if (refreshing && refreshingFinished) {\n        this.resetRefreshingState();\n      } else {\n        this.setState({\n          spinnerY: refreshing ? this.params.refreshing : this.params.start,\n          spinnerProgress: 0,\n          contentShift: 0,\n        });\n      }\n    });\n  };\n\n  runRefreshing() {\n    if (!this.state.refreshing && this.props.onRefresh) {\n      this.setState({\n        refreshing: true,\n        spinnerY: this.props.platform === ANDROID ? this.params.refreshing : this.state.spinnerY,\n      });\n\n      this.props.onRefresh();\n    }\n  }\n\n  onRefreshingFinish: VoidFunction = () => {\n    this.setState({\n      refreshingFinished: true,\n    }, () => {\n      !this.state.touchDown && this.resetRefreshingState();\n    });\n  };\n\n  resetRefreshingState() {\n    this.setState({\n      watching: false,\n      canRefresh: false,\n      refreshing: false,\n      refreshingFinished: false,\n      spinnerY: this.params.start,\n      spinnerProgress: 0,\n      contentShift: 0,\n    });\n  }\n\n  render() {\n    const { children, className, onRefresh, isFetching, platform, ...restProps } = this.props;\n    const { watching, refreshing, spinnerY, spinnerProgress, canRefresh, touchDown, contentShift } = this.state;\n\n    const spinnerTransform = `translate3d(0, ${spinnerY}px, 0)`;\n    let contentTransform = '';\n\n    if (platform === IOS && refreshing && !touchDown) {\n      contentTransform = 'translate3d(0, 100px, 0)';\n    } else if (platform === IOS && contentShift) {\n      contentTransform = `translate3d(0, ${contentShift}px, 0)`;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <Touch\n          {...restProps}\n          onStart={this.onTouchStart}\n          onMove={this.onTouchMove}\n          onEnd={this.onTouchEnd}\n          className={classNames(getClassName('PullToRefresh', platform), className, {\n            'PullToRefresh--watching': watching,\n            'PullToRefresh--refreshing': refreshing,\n          })}\n        >\n          <FixedLayout className=\"PullToRefresh__controls\">\n            <PullToRefreshSpinner\n              style={{\n                transform: spinnerTransform,\n                WebkitTransform: spinnerTransform,\n                opacity: watching || refreshing || canRefresh ? 1 : 0,\n              }}\n              on={refreshing}\n              progress={refreshing ? null : spinnerProgress}\n            />\n          </FixedLayout>\n\n          <div\n            className=\"PullToRefresh__content\"\n            ref={this.contentRef}\n            style={{\n              transform: contentTransform,\n              WebkitTransform: contentTransform,\n            }}\n          >\n            {children}\n          </div>\n        </Touch>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport default withPlatform(PullToRefresh);\n"]},"metadata":{},"sourceType":"module"}